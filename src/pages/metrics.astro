---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { createClient } from "@supabase/supabase-js";

const expectedKey = import.meta.env.ADMIN_ACCESS_KEY;
const requestUrl = new URL(Astro.request.url);
const key = requestUrl.searchParams.get("key");

// Protect route with shared secret
if (!expectedKey || key !== expectedKey) {
  return Astro.redirect("/");
}

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const serviceKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceKey) {
  throw new Error("Supabase admin credentials are missing.");
}

const supabase = createClient(supabaseUrl, serviceKey);

// Daily metrics from view (last 7 days, most recent first)
const { data: dailyMetrics = [], error: metricsError } = await supabase
  .from("daily_metrics")
  .select("*")
  .order("day", { ascending: false })
  .limit(7);

if (metricsError) {
  console.error(metricsError);
  throw metricsError;
}

// Totals
const { count: totalBusinesses } = await supabase
  .from("businesses")
  .select("*", { count: "exact", head: true });

const { count: totalSuggestions } = await supabase
  .from("business_suggestions")
  .select("*", { count: "exact", head: true });

const { count: totalSearches } = await supabase
  .from("search_events")
  .select("*", { count: "exact", head: true });

// Today snapshot
const todayMetrics =
  dailyMetrics && dailyMetrics.length > 0 ? dailyMetrics[0] : null;

const formatDate = (value: string | Date) =>
  new Date(value).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });
---

<Layout title="Metrics â€¢ VantaJax">
  <section class="py-10 px-4">
    <div class="mx-auto max-w-5xl space-y-8">
      <header class="space-y-1">
        <p class="text-[11px] font-semibold uppercase tracking-[0.25em] text-purple-600">
          Admin
        </p>
        <h1 class="text-xl sm:text-2xl font-semibold text-slate-900">
          Metrics
        </h1>
        <p class="text-[11px] text-slate-600">
          High-level analytics for VantaJax. This view is based on the last 7 days of
          activity.
        </p>
      </header>

      <!-- Summary cards -->
      <section class="grid gap-4 sm:grid-cols-3">
        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-500">
            Businesses
          </h2>
          <p class="mt-2 text-2xl font-semibold text-slate-900">
            {totalBusinesses ?? 0}
          </p>
          <p class="mt-1 text-[11px] text-slate-500">
            Total live directory entries.
          </p>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-500">
            Suggestions
          </h2>
          <p class="mt-2 text-2xl font-semibold text-slate-900">
            {totalSuggestions ?? 0}
          </p>
          <p class="mt-1 text-[11px] text-slate-500">
            Community-submitted businesses.
          </p>
        </div>

        <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
          <h2 class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-500">
            Searches
          </h2>
          <p class="mt-2 text-2xl font-semibold text-slate-900">
            {totalSearches ?? 0}
          </p>
          <p class="mt-1 text-[11px] text-slate-500">
            Total directory searches logged.
          </p>
        </div>
      </section>

      <!-- Today snapshot -->
      <section class="space-y-3">
        <h2 class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">
          Today
        </h2>
        {todayMetrics ? (
          <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm">
            <p class="text-[11px] text-slate-500 mb-3">
              {formatDate(todayMetrics.day)}
            </p>
            <div class="grid gap-4 sm:grid-cols-4">
              <div class="space-y-1">
                <p class="text-[11px] text-slate-500">Searches</p>
                <p class="text-base font-semibold text-slate-900">
                  {todayMetrics.searches}
                </p>
              </div>
              <div class="space-y-1">
                <p class="text-[11px] text-slate-500">Zero-result</p>
                <p class="text-base font-semibold text-slate-900">
                  {todayMetrics.zero_result_searches}
                </p>
              </div>
              <div class="space-y-1">
                <p class="text-[11px] text-slate-500">Suggestions</p>
                <p class="text-base font-semibold text-slate-900">
                  {todayMetrics.suggestions}
                </p>
              </div>
              <div class="space-y-1">
                <p class="text-[11px] text-slate-500">New businesses</p>
                <p class="text-base font-semibold text-slate-900">
                  {todayMetrics.new_businesses}
                </p>
              </div>
            </div>
          </div>
        ) : (
          <p class="text-[11px] text-slate-500">
            No metrics recorded for today yet.
          </p>
        )}
      </section>

      <!-- 7-day table -->
      <section class="space-y-3">
        <h2 class="text-xs font-semibold uppercase tracking-[0.18em] text-slate-500">
          Last 7 days
        </h2>
        <div class="overflow-x-auto rounded-2xl border border-slate-200 bg-white shadow-sm">
          <table class="min-w-full text-left text-[11px] text-slate-700">
            <thead class="border-b border-slate-200 bg-slate-50 text-[10px] uppercase tracking-[0.15em] text-slate-500">
              <tr>
                <th class="px-3 py-2">Day</th>
                <th class="px-3 py-2">Searches</th>
                <th class="px-3 py-2">Zero-result</th>
                <th class="px-3 py-2">Avg. results</th>
                <th class="px-3 py-2">Suggestions</th>
                <th class="px-3 py-2">New businesses</th>
              </tr>
            </thead>
            <tbody>
              {dailyMetrics.map((row) => (
                <tr class="border-t border-slate-100">
                  <td class="px-3 py-2 text-slate-600">
                    {formatDate(row.day)}
                  </td>
                  <td class="px-3 py-2">{row.searches}</td>
                  <td class="px-3 py-2">{row.zero_result_searches}</td>
                  <td class="px-3 py-2">
                    {Number(row.avg_results).toFixed(1)}
                  </td>
                  <td class="px-3 py-2">{row.suggestions}</td>
                  <td class="px-3 py-2">{row.new_businesses}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>
    </div>
  </section>
</Layout>
