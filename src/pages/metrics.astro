---
export const prerender = false;

import Layout from "../layouts/Layout.astro";
import { createClient } from "@supabase/supabase-js";

const expectedKey = import.meta.env.ADMIN_ACCESS_KEY;
const requestUrl = new URL(Astro.request.url);
const key = requestUrl.searchParams.get("key");

// Protect route with shared secret
if (!expectedKey || key !== expectedKey) {
  return Astro.redirect("/");
}

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const serviceKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceKey) {
  throw new Error("Server Supabase credentials not configured");
}

const supabase = createClient(supabaseUrl, serviceKey);

// Daily metrics from view (most recent first)
const { data: dailyMetrics, error: metricsError } = await supabase
  .from("daily_metrics")
  .select("*")
  .order("day", { ascending: false });

if (metricsError) {
  console.error(metricsError);
  throw metricsError;
}

// Totals
const { count: totalBusinesses } = await supabase
  .from("businesses")
  .select("*", { count: "exact", head: true });

const { count: totalVerifiedBusinesses } = await supabase
  .from("businesses")
  .select("*", { count: "exact", head: true })
  .eq("verified", true);

const { count: totalSuggestions } = await supabase
  .from("business_suggestions")
  .select("*", { count: "exact", head: true });

const { count: totalSearches } = await supabase
  .from("search_events")
  .select("*", { count: "exact", head: true });

// Today snapshot
const todayMetrics =
  dailyMetrics && dailyMetrics.length > 0 ? dailyMetrics[0] : null;

// 7-day aggregate (or however many rows you have)
const recentMetrics = dailyMetrics ? dailyMetrics.slice(0, 7) : [];

const aggregate = recentMetrics.reduce(
  (acc, row: any) => {
    acc.searches += row.searches ?? 0;
    acc.zeroResultSearches += row.zero_result_searches ?? 0;
    acc.suggestions += row.suggestions ?? 0;
    acc.newBusinesses += row.new_businesses ?? 0;
    acc.avgResultsSum += Number(row.avg_results ?? 0);
    acc.days += 1;
    return acc;
  },
  {
    searches: 0,
    zeroResultSearches: 0,
    suggestions: 0,
    newBusinesses: 0,
    avgResultsSum: 0,
    days: 0,
  }
);

const avgResultsLast7 =
  aggregate.days > 0 ? aggregate.avgResultsSum / aggregate.days : 0;

const formatDate = (value: string | Date) =>
  new Date(value).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });
---

<Layout title="Metrics – VantaJax">
  <section class="py-6 space-y-6">
    <header class="space-y-2">
      <div class="flex flex-wrap items-center justify-between gap-2">
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold text-slate-50">
            Metrics
          </h1>
          <p class="text-[11px] text-slate-400">
            High-level analytics based on recent activity, search events, and
            suggestions.
          </p>
        </div>
        <a
          href={`/admin?key=${key}`}
          class="rounded-lg border border-purple-700/70 bg-black/70 px-3 py-1.5 text-[11px] font-medium text-purple-200 hover:border-purple-400 hover:text-purple-50"
        >
          Go to admin
        </a>
      </div>
    </header>

    <!-- Summary cards -->
    <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
      <div
        class="rounded-2xl border border-purple-900/60 bg-black/70 p-4 shadow-[0_0_20px_rgba(76,29,149,0.6)]"
      >
        <h2
          class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400"
        >
          Businesses
        </h2>
        <p class="mt-2 text-2xl font-semibold text-slate-50">
          {totalBusinesses ?? 0}
        </p>
        <p class="mt-1 text-[11px] text-slate-500">
          Total live directory entries.
        </p>
      </div>

      <div
        class="rounded-2xl border border-purple-900/60 bg-black/70 p-4 shadow-[0_0_20px_rgba(76,29,149,0.6)]"
      >
        <h2
          class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400"
        >
          Verified businesses
        </h2>
        <p class="mt-2 text-2xl font-semibold text-slate-50">
          {totalVerifiedBusinesses ?? 0}
        </p>
        <p class="mt-1 text-[11px] text-slate-500">
          Marked as verified Black-owned.
        </p>
      </div>

      <div
        class="rounded-2xl border border-purple-900/60 bg-black/70 p-4 shadow-[0_0_20px_rgba(76,29,149,0.6)]"
      >
        <h2
          class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400"
        >
          Suggestions (open)
        </h2>
        <p class="mt-2 text-2xl font-semibold text-slate-50">
          {totalSuggestions ?? 0}
        </p>
        <p class="mt-1 text-[11px] text-slate-500">
          Community submissions waiting in the queue.
        </p>
      </div>

      <div
        class="rounded-2xl border border-purple-900/60 bg-black/70 p-4 shadow-[0_0_20px_rgba(76,29,149,0.6)]"
      >
        <h2
          class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400"
        >
          Searches (all time)
        </h2>
        <p class="mt-2 text-2xl font-semibold text-slate-50">
          {totalSearches ?? 0}
        </p>
        <p class="mt-1 text-[11px] text-slate-500">
          Total recorded searches in the directory.
        </p>
      </div>
    </section>

    <!-- Today snapshot -->
    {
      todayMetrics && (
        <section
          class="rounded-2xl border border-purple-900/60 bg-black/80 p-4 shadow-[0_0_25px_rgba(76,29,149,0.7)] space-y-3"
        >
          <div class="flex items-center justify-between gap-2">
            <h2
              class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400"
            >
              Today’s snapshot • {formatDate(todayMetrics.day)}
            </h2>
            <p class="text-[11px] text-slate-500">
              Based on daily_metrics view.
            </p>
          </div>
          <div class="grid gap-4 sm:grid-cols-4">
            <div class="space-y-1">
              <p class="text-[11px] text-slate-400">Searches</p>
              <p class="text-base font-semibold text-slate-50">
                {todayMetrics.searches}
              </p>
            </div>
            <div class="space-y-1">
              <p class="text-[11px] text-slate-400">Zero-result searches</p>
              <p class="text-base font-semibold text-slate-50">
                {todayMetrics.zero_result_searches}
              </p>
            </div>
            <div class="space-y-1">
              <p class="text-[11px] text-slate-400">Suggestions</p>
              <p class="text-base font-semibold text-slate-50">
                {todayMetrics.suggestions}
              </p>
            </div>
            <div class="space-y-1">
              <p class="text-[11px] text-slate-400">New businesses</p>
              <p class="text-base font-semibold text-slate-50">
                {todayMetrics.new_businesses}
              </p>
            </div>
          </div>
        </section>
      )
    }

    <!-- 7-day overview -->
    {
      recentMetrics && recentMetrics.length > 0 && (
        <section class="grid gap-4 sm:grid-cols-2 lg:grid-cols-4">
          <div class="rounded-2xl border border-purple-900/60 bg-black/70 p-4">
            <p class="text-[11px] text-slate-400 uppercase tracking-[0.18em]">
              Searches (7 days)
            </p>
            <p class="mt-2 text-lg font-semibold text-slate-50">
              {aggregate.searches}
            </p>
            <p class="mt-1 text-[11px] text-slate-500">
              Total searches across the last {aggregate.days} day(s).
            </p>
          </div>
          <div class="rounded-2xl border border-purple-900/60 bg-black/70 p-4">
            <p class="text-[11px] text-slate-400 uppercase tracking-[0.18em]">
              Zero-result (7 days)
            </p>
            <p class="mt-2 text-lg font-semibold text-slate-50">
              {aggregate.zeroResultSearches}
            </p>
            <p class="mt-1 text-[11px] text-slate-500">
              Searches that returned zero results.
            </p>
          </div>
          <div class="rounded-2xl border border-purple-900/60 bg-black/70 p-4">
            <p class="text-[11px] text-slate-400 uppercase tracking-[0.18em]">
              Avg results / search
            </p>
            <p class="mt-2 text-lg font-semibold text-slate-50">
              {avgResultsLast7.toFixed(1)}
            </p>
            <p class="mt-1 text-[11px] text-slate-500">
              Mean of daily average results in the last {aggregate.days} day(s).
            </p>
          </div>
          <div class="rounded-2xl border border-purple-900/60 bg-black/70 p-4">
            <p class="text-[11px] text-slate-400 uppercase tracking-[0.18em]">
              Suggestions & new businesses
            </p>
            <p class="mt-2 text-lg font-semibold text-slate-50">
              {aggregate.suggestions} / {aggregate.newBusinesses}
            </p>
            <p class="mt-1 text-[11px] text-slate-500">
              Suggestions vs. new businesses added.
            </p>
          </div>
        </section>
      )
    }

    <!-- 7-day table -->
    <section class="space-y-2">
      <h2
        class="text-[11px] font-semibold uppercase tracking-[0.18em] text-slate-400"
      >
        Daily breakdown
      </h2>

      <div
        class="overflow-x-auto rounded-2xl border border-purple-900/60 bg-black/70 shadow-[0_0_20px_rgba(76,29,149,0.6)]"
      >
        <table
          class="min-w-full border-collapse text-left text-[11px] text-slate-200"
        >
          <thead class="border-b border-purple-900/60 bg-black">
            <tr>
              <th class="px-3 py-2 font-semibold text-slate-300">Day</th>
              <th class="px-3 py-2 font-semibold text-slate-300">Searches</th>
              <th class="px-3 py-2 font-semibold text-slate-300">
                Zero-result
              </th>
              <th class="px-3 py-2 font-semibold text-slate-300">
                Avg results
              </th>
              <th class="px-3 py-2 font-semibold text-slate-300">
                Suggestions
              </th>
              <th class="px-3 py-2 font-semibold text-slate-300">
                New businesses
              </th>
            </tr>
          </thead>
          <tbody>
            {
              dailyMetrics && dailyMetrics.length > 0 ? (
                dailyMetrics.map((row: any) => (
                  <tr
                    class="border-t border-purple-900/40 bg-black/60 hover:bg-black/80"
                  >
                    <td class="px-3 py-2 text-slate-100">
                      {formatDate(row.day)}
                    </td>
                    <td class="px-3 py-2">{row.searches}</td>
                    <td class="px-3 py-2">
                      {row.zero_result_searches}
                    </td>
                    <td class="px-3 py-2">
                      {Number(row.avg_results).toFixed(1)}
                    </td>
                    <td class="px-3 py-2">
                      {row.suggestions}
                    </td>
                    <td class="px-3 py-2">
                      {row.new_businesses}
                    </td>
                  </tr>
                ))
              ) : (
                <tr>
                  <td class="px-3 py-3 text-slate-400" colspan="6">
                    No metrics available yet. Try again after you have some
                    searches and suggestions.
                  </td>
                </tr>
              )
            }
          </tbody>
        </table>
      </div>
    </section>
  </section>
</Layout>
