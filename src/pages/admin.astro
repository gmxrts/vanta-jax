---
import Layout from "../layouts/Layout.astro";
import Analytics from "@vercel/analytics/astro";
import AdminDashboard from "../components/AdminDashboard";
import { createClient } from "@supabase/supabase-js";

export const prerender = false;

const expectedKey = import.meta.env.ADMIN_ACCESS_KEY;
const requestUrl = new URL(Astro.request.url);
const key = requestUrl.searchParams.get("key");

// If no key or wrong key, bounce to home
if (!expectedKey || key !== expectedKey) {
  return Astro.redirect("/");
}

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const serviceKey = import.meta.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !serviceKey) {
  console.warn("Supabase admin credentials are missing. Check env vars.");
}

const supabase =
  supabaseUrl && serviceKey ? createClient(supabaseUrl, serviceKey) : null;

const { data: suggestions = [], error } =
  supabase
    ? await supabase
        .from("business_suggestions")
        .select("*")
        .order("created_at", { ascending: false })
    : { data: [], error: null };

if (error) {
  console.error("Error loading suggestions for admin:", error);
}
---

<Layout title="Admin • VantaJax">
  <section class="py-10 px-4">
    <div class="mx-auto max-w-5xl space-y-6">
      <header class="flex flex-wrap items-baseline justify-between gap-3">
        <div class="space-y-1">
          <p class="text-[11px] font-semibold uppercase tracking-[0.25em] text-purple-600">
            Admin
          </p>
          <h1 class="text-xl sm:text-2xl font-semibold text-slate-900">
            Business suggestions
          </h1>
          <p class="text-[11px] text-slate-600 max-w-xl">
            Internal view for reviewing and promoting community-submitted suggestions into
            the main directory. This page is not public.
          </p>
        </div>

        <a
          href="/businesses"
          class="text-[11px] text-purple-700 hover:text-purple-900 underline underline-offset-2"
        >
          ← Back to search
        </a>
      </header>

      <AdminDashboard client:load suggestions={suggestions} />
    </div>
  </section>

  <Analytics />
</Layout>
