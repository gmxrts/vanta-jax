---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabaseClient";

const { id } = Astro.params;

const { data: business, error } = await supabase
  .from("businesses")
  .select("*")
  .eq("id", id)
  .single();

if (error) console.error("Error loading business:", error);

const fullAddress = business
  ? [
      business.address,
      [business.city, business.state].filter(Boolean).join(", "),
      business.zip,
    ]
      .filter(Boolean)
      .join(" ")
  : "";

const safeUrl = (url: any) => {
  if (!url) return "";
  const trimmed = String(url).trim();
  if (!trimmed) return "";
  if (/^https?:\/\//i.test(trimmed)) return trimmed;
  return `https://${trimmed}`;
};

const mapsUrl = fullAddress
  ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(fullAddress)}`
  : "";
---

<Layout title={business ? business.name : "Business • VantaJax"}>
  <main class="min-h-[70vh] bg-white">
    {business ? (
      <section class="relative overflow-hidden px-4 pt-12 pb-16">
        <!-- Luxury background -->
        <div class="pointer-events-none absolute inset-0">
          <div class="absolute -top-28 left-1/2 h-72 w-184 -translate-x-1/2 rounded-full bg-purple-600/10 blur-3xl"></div>
          <div class="absolute top-20 left-1/4 h-56 w-96 -translate-x-1/2 rounded-full bg-fuchsia-500/10 blur-3xl"></div>
          <div class="absolute inset-0 bg-linear-to-b from-slate-50 via-white to-white"></div>
          <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,rgba(88,28,135,0.06),transparent_55%)]"></div>
        </div>

        <div class="relative mx-auto w-full max-w-6xl space-y-6">
          <!-- Top nav -->
          <div class="flex flex-wrap items-center justify-between gap-3">
            <a
              href="/businesses"
              class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/70 px-4 py-2 text-[12px] font-semibold text-slate-800 shadow-sm backdrop-blur transition hover:-translate-y-0.5 hover:bg-white"
            >
              ← Back to search
            </a>

            <div class="flex flex-wrap items-center gap-2">
              {business.verified && (
                <span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-[11px] font-semibold text-emerald-700 shadow-sm">
                  Verified
                </span>
              )}
              {business.featured && (
                <span class="inline-flex items-center rounded-full border border-purple-200 bg-purple-50 px-3 py-1 text-[11px] font-semibold text-purple-700 shadow-sm">
                  Featured
                </span>
              )}
            </div>
          </div>

          <!-- Hero -->
          <header class="rounded-[28px] border border-slate-200/70 bg-white/70 p-6 sm:p-8 shadow-[0_18px_48px_-40px_rgba(2,6,23,0.7)] backdrop-blur">
            <p class="text-[11px] font-semibold uppercase tracking-[0.25em] text-purple-600">
              Business profile
            </p>

            <div class="mt-2 flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
              <div class="min-w-0">
                <h1 class="text-2xl sm:text-4xl font-semibold tracking-tight text-slate-900">
                  {business.name}
                </h1>

                <div class="mt-2 flex flex-wrap items-center gap-2 text-[12px] text-slate-600">
                  <span class="rounded-full border border-slate-200 bg-white/60 px-3 py-1 shadow-sm backdrop-blur capitalize">
                    {business.category}
                  </span>

                  {(business.city || business.state) && (
                    <span class="rounded-full border border-slate-200 bg-white/60 px-3 py-1 shadow-sm backdrop-blur">
                      {[business.city, business.state].filter(Boolean).join(", ")}
                    </span>
                  )}

                  {business.area && (
                    <span class="rounded-full border border-slate-200 bg-white/60 px-3 py-1 shadow-sm backdrop-blur">
                      Serving: {business.area}
                    </span>
                  )}
                </div>
              </div>

              <div class="flex flex-wrap items-center gap-2">
                <button
                  id="copy-link"
                  class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white/70 px-4 py-2 text-[12px] font-semibold text-slate-800 shadow-sm backdrop-blur transition hover:-translate-y-0.5 hover:bg-white"
                >
                  Copy link
                </button>

                {fullAddress && (
                  <a
                    id="open-in-maps-hero"
                    href={mapsUrl}
                    data-address={fullAddress}
                    target="_blank"
                    rel="noreferrer"
                    class="inline-flex items-center justify-center rounded-2xl bg-purple-600 px-4 py-2 text-[12px] font-semibold text-white shadow-[0_16px_34px_-22px_rgba(147,51,234,0.65)] transition hover:-translate-y-0.5 hover:bg-purple-700"
                  >
                    Directions
                  </a>
                )}
              </div>
            </div>

            {business.description && (
              <div class="mt-6 space-y-2">
                <h2 class="text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-500">
                  About
                </h2>
                <p class="text-[13px] leading-relaxed text-slate-700">
                  {business.description}
                </p>
              </div>
            )}
          </header>

          <!-- Content grid (no arbitrary template strings) -->
          <div class="grid gap-6 lg:grid-cols-3">
            <!-- Left: details (2 cols on desktop) -->
            <div class="space-y-6 lg:col-span-2">
              <section class="rounded-[28px] border border-slate-200/70 bg-white/70 p-6 sm:p-8 shadow-[0_18px_48px_-40px_rgba(2,6,23,0.7)] backdrop-blur">
                <h2 class="text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-500">
                  Details
                </h2>

                <div class="mt-5 divide-y divide-slate-200/70">
                  <div class="flex items-start justify-between gap-3 py-3">
                    <div class="flex items-center gap-2">
                      <span class="h-2 w-2 rounded-full bg-slate-300 mt-1.5"></span>
                      <span class="text-[12px] font-semibold text-slate-900">Phone</span>
                    </div>
                    {business.phone ? (
                      <a
                        href={`tel:${business.phone}`}
                        class="text-[12px] font-semibold text-purple-700 underline underline-offset-2 hover:text-purple-900"
                      >
                        {business.phone}
                      </a>
                    ) : (
                      <span class="text-[12px] text-slate-500">Not provided</span>
                    )}
                  </div>

                  <div class="flex items-start justify-between gap-3 py-3">
                    <div class="flex items-center gap-2">
                      <span class="h-2 w-2 rounded-full bg-slate-300 mt-1.5"></span>
                      <span class="text-[12px] font-semibold text-slate-900">Website</span>
                    </div>
                    {business.website ? (
                      <a
                        href={safeUrl(business.website)}
                        target="_blank"
                        rel="noreferrer"
                        class="text-[12px] font-semibold text-purple-700 underline underline-offset-2 hover:text-purple-900"
                      >
                        Visit
                      </a>
                    ) : (
                      <span class="text-[12px] text-slate-500">Not provided</span>
                    )}
                  </div>

                  <div class="flex items-start justify-between gap-3 py-3">
                    <div class="flex items-center gap-2">
                      <span class="h-2 w-2 rounded-full bg-slate-300 mt-1.5"></span>
                      <span class="text-[12px] font-semibold text-slate-900">Address</span>
                    </div>
                    {fullAddress ? (
                      <span class="text-right text-[12px] text-slate-700">{fullAddress}</span>
                    ) : (
                      <span class="text-[12px] text-slate-500">Not provided</span>
                    )}
                  </div>
                </div>
              </section>

              <section class="rounded-[28px] border border-slate-200/70 bg-white/70 p-6 sm:p-8 shadow-[0_18px_48px_-40px_rgba(2,6,23,0.7)] backdrop-blur">
                <h2 class="text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-500">
                  Community note
                </h2>
                <p class="mt-3 text-[13px] leading-relaxed text-slate-700">
                  VantaJax highlights Black-owned businesses and professionals to help the community discover, support, and circulate dollars locally.
                </p>
              </section>
            </div>

            <!-- Right: actions (sticky on desktop) -->
            <aside class="lg:col-span-1">
              <div class="space-y-6 lg:sticky lg:top-24">
                <section class="rounded-[28px] border border-slate-200/70 bg-white/70 p-6 sm:p-8 shadow-[0_18px_48px_-40px_rgba(2,6,23,0.7)] backdrop-blur">
                  <h2 class="text-[10px] font-semibold uppercase tracking-[0.2em] text-slate-500">
                    Actions
                  </h2>

                  <div class="mt-4 grid gap-3">
                    {fullAddress ? (
                      <a
                        id="open-in-maps"
                        href={mapsUrl}
                        data-address={fullAddress}
                        target="_blank"
                        rel="noreferrer"
                        class="inline-flex items-center justify-center rounded-2xl bg-purple-600 px-4 py-3 text-[13px] font-semibold text-white shadow-[0_16px_34px_-22px_rgba(147,51,234,0.65)] transition hover:-translate-y-0.5 hover:bg-purple-700"
                      >
                        Directions
                      </a>
                    ) : (
                      <button
                        class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white/60 px-4 py-3 text-[13px] font-semibold text-slate-500 shadow-sm backdrop-blur"
                        disabled
                      >
                        Directions unavailable
                      </button>
                    )}

                    {business.website ? (
                      <a
                        href={safeUrl(business.website)}
                        target="_blank"
                        rel="noreferrer"
                        class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 text-[13px] font-semibold text-slate-800 shadow-sm backdrop-blur transition hover:-translate-y-0.5 hover:bg-white"
                      >
                        Website
                      </a>
                    ) : null}

                    {business.phone ? (
                      <a
                        href={`tel:${business.phone}`}
                        class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 text-[13px] font-semibold text-slate-800 shadow-sm backdrop-blur transition hover:-translate-y-0.5 hover:bg-white"
                      >
                        Call
                      </a>
                    ) : null}

                    <button
                      id="share"
                      class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white/70 px-4 py-3 text-[13px] font-semibold text-slate-800 shadow-sm backdrop-blur transition hover:-translate-y-0.5 hover:bg-white"
                    >
                      Share
                    </button>
                  </div>

                  <p class="mt-4 text-[11px] text-slate-500 leading-relaxed">
                    Tip: If a link doesn’t open correctly on mobile, try “Copy link” and paste into your browser.
                  </p>
                </section>
              </div>
            </aside>
          </div>
        </div>

        <!-- Keep your deep-link behavior + copy/share -->
        <script is:inline>
          {`
            (function () {
              const copyBtn = document.getElementById('copy-link');
              if (copyBtn) {
                copyBtn.addEventListener('click', async function () {
                  try {
                    await navigator.clipboard.writeText(window.location.href);
                    copyBtn.textContent = 'Copied';
                    setTimeout(() => (copyBtn.textContent = 'Copy link'), 1200);
                  } catch (e) {
                    copyBtn.textContent = 'Copy failed';
                    setTimeout(() => (copyBtn.textContent = 'Copy link'), 1200);
                  }
                });
              }

              const shareBtn = document.getElementById('share');
              if (shareBtn) {
                shareBtn.addEventListener('click', async function () {
                  const data = { title: document.title, url: window.location.href };
                  try {
                    if (navigator.share) {
                      await navigator.share(data);
                    } else if (navigator.clipboard) {
                      await navigator.clipboard.writeText(window.location.href);
                      shareBtn.textContent = 'Copied';
                      setTimeout(() => (shareBtn.textContent = 'Share'), 1200);
                    }
                  } catch (e) {}
                });
              }

              function wireMaps(id) {
                const link = document.getElementById(id);
                if (!link) return;

                link.addEventListener('click', function (event) {
                  const address = link.getAttribute('data-address') || '';
                  if (!navigator || !navigator.userAgent) return;

                  const ua = navigator.userAgent.toLowerCase();
                  const isIOS = /iphone|ipad|ipod/.test(ua) && !window.MSStream;
                  const isAndroid = /android/.test(ua);

                  if (isIOS) {
                    event.preventDefault();
                    window.location.href = 'maps://?q=' + encodeURIComponent(address);
                  } else if (isAndroid) {
                    event.preventDefault();
                    window.location.href = 'geo:0,0?q=' + encodeURIComponent(address);
                  }
                });
              }

              wireMaps('open-in-maps');
              wireMaps('open-in-maps-hero');
            })();
          `}
        </script>
      </section>
    ) : (
      <section class="px-4 py-16">
        <div class="mx-auto max-w-2xl rounded-[28px] border border-slate-200/70 bg-white/70 p-8 text-center shadow-sm backdrop-blur">
          <p class="text-[11px] font-semibold uppercase tracking-[0.25em] text-slate-500">
            Not found
          </p>
          <h1 class="mt-2 text-2xl font-semibold text-slate-900">
            Business not found
          </h1>
          <p class="mt-2 text-[12px] text-slate-600">
            The listing you’re looking for may have been removed or the link may be incorrect.
          </p>
          <a
            href="/businesses"
            class="mt-6 inline-flex items-center justify-center rounded-2xl bg-purple-600 px-5 py-3 text-[13px] font-semibold text-white shadow-[0_16px_34px_-22px_rgba(147,51,234,0.65)] transition hover:-translate-y-0.5 hover:bg-purple-700"
          >
            Back to search
          </a>
        </div>
      </section>
    )}
  </main>
</Layout>
