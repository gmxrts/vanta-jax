---
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabaseClient";

const { id } = Astro.params;

const { data: business, error } = await supabase
  .from("businesses")
  .select("*")
  .eq("id", id)
  .single();

if (error) {
  console.error("Error loading business:", error);
}

// Helper to build full address string
const fullAddress = business
  ? [
      business.address,
      [business.city, business.state].filter(Boolean).join(", "),
      business.zip,
    ]
      .filter(Boolean)
      .join(" ")
  : "";
---

<Layout title={business ? business.name : "Business ‚Ä¢ VantaJax"}>
  <main class="min-h-[60vh] px-4 py-8">
    {business ? (
      <div class="mx-auto max-w-2xl space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <!-- Header -->
        <header class="flex flex-col gap-3 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h1 class="text-2xl font-semibold text-slate-900 sm:text-3xl">
              {business.name}
            </h1>
            <p class="mt-1 text-sm text-slate-600 capitalize">
              {business.category}
            </p>
            {business.area && (
              <p class="mt-1 text-xs text-slate-500">
                Serving: {business.area}
              </p>
            )}
          </div>

          <div class="flex flex-wrap gap-2 justify-start sm:justify-end">
            {business.verified && (
              <span class="inline-flex items-center rounded-full bg-emerald-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-emerald-700 border border-emerald-300">
                Verified
              </span>
            )}
            {business.featured && (
              <span class="inline-flex items-center rounded-full bg-purple-100 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-purple-700 border border-purple-300">
                Featured
              </span>
            )}
          </div>
        </header>

        {/* Description */}
        {business.description && (
          <section class="space-y-1">
            <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
              About
            </h2>
            <p class="text-sm leading-relaxed text-slate-700">
              {business.description}
            </p>
          </section>
        )}

        {/* Contact / info */}
        <section class="grid gap-4 sm:grid-cols-2">
          <div class="space-y-3">
            <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
              Details
            </h2>

            {business.phone && (
              <p class="text-sm text-slate-700">
                üìû{" "}
                <a
                  href={`tel:${business.phone}`}
                  class="text-purple-700 underline underline-offset-2 hover:text-purple-900"
                >
                  {business.phone}
                </a>
              </p>
            )}

            {business.website && (
              <p class="text-sm text-slate-700">
                üåê{" "}
                <a
                  href={business.website}
                  target="_blank"
                  rel="noreferrer"
                  class="text-purple-700 underline underline-offset-2 hover:text-purple-900"
                >
                  Visit website
                </a>
              </p>
            )}

            {fullAddress && (
              <p class="text-sm text-slate-700">
                üìç {fullAddress}
              </p>
            )}
          </div>

          <div class="space-y-3">
            <h2 class="text-xs font-semibold uppercase tracking-[0.2em] text-slate-500">
              Location
            </h2>

            {fullAddress ? (
              <>
                <a
                  id="open-in-maps"
                  href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(
                    fullAddress
                  )}`}
                  data-address={fullAddress}
                  target="_blank"
                  rel="noreferrer"
                  class="inline-flex items-center justify-center rounded-xl border border-purple-200 bg-purple-50 px-4 py-2 text-sm font-medium text-purple-700 shadow-sm hover:bg-purple-100"
                >
                  Open in Maps
                </a>

                <script>
                  {`
                  (function () {
                    const link = document.getElementById('open-in-maps');
                    if (!link) return;

                    link.addEventListener('click', function (event) {
                      const address = link.getAttribute('data-address') || '';
                      const hasNavigator = typeof navigator !== 'undefined';

                      if (!hasNavigator || !navigator.userAgent) {
                        return;
                      }

                      const ua = navigator.userAgent.toLowerCase();
                      const isIOS =
                        /iphone|ipad|ipod/.test(ua) && !window.MSStream;
                      const isAndroid = /android/.test(ua);

                      if (isIOS) {
                        event.preventDefault();
                        window.location.href = 'maps://?q=' + encodeURIComponent(address);
                      } else if (isAndroid) {
                        event.preventDefault();
                        window.location.href =
                          'geo:0,0?q=' + encodeURIComponent(address);
                      }
                    });
                  })();
                `}
                </script>
              </>
            ) : (
              <p class="text-sm text-slate-500">
                No address available for this business.
              </p>
            )}
          </div>
        </section>
      </div>
    ) : (
      <p class="text-center text-sm text-slate-500">
        Business not found.
      </p>
    )}
  </main>
</Layout>
